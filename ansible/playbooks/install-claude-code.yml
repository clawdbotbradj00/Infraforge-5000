---
- name: Install NVM, Node.js v22, and Claude Code for all users
  hosts: targets
  become: true

  vars:
    nvm_version: "v0.40.4"
    node_version: "v22"
    nvm_install_url: "https://raw.githubusercontent.com/nvm-sh/nvm/{{ nvm_version }}/install.sh"
    # SHA256 of the install.sh for the pinned nvm_version — update both together
    nvm_install_sha256: "4b7412c49960c7d31e8df72da90c1fb5b8cccb419ac99537b737028d497aba4f"

  tasks:
    # ── Ensure acl is installed (required for become_user) ────────────
    - name: Install acl package (Debian/Ubuntu)
      apt:
        name: acl
        state: present
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: Install acl package (RHEL/CentOS)
      yum:
        name: acl
        state: present
      when: ansible_os_family == "RedHat"

    # ── Gather target users ─────────────────────────────────────────────
    - name: Get all users with a real login shell and home directory
      shell: |
        awk -F: '($3 == 0 || $3 >= 1000) && $7 !~ /nologin|false/ { print $1":"$6 }' /etc/passwd
      register: user_list_raw
      changed_when: false

    - name: Filter to users with existing home directories
      set_fact:
        user_list: "{{ user_list_raw.stdout_lines | select('search', ':(/root|/home/)') | list }}"

    # ── Ensure curl is installed ────────────────────────────────────────
    - name: Install curl (Debian/Ubuntu)
      apt:
        name: curl
        state: present
      when: ansible_os_family == "Debian"

    - name: Install curl (RHEL/CentOS)
      yum:
        name: curl
        state: present
      when: ansible_os_family == "RedHat"

    # ── Install NVM per user ────────────────────────────────────────────
    - name: Check if NVM is already installed for each user
      stat:
        path: "{{ item.split(':')[1] }}/.nvm/nvm.sh"
      register: nvm_check
      loop: "{{ user_list }}"
      loop_control:
        label: "{{ item.split(':')[0] }}"

    # STILL-05 fix: Download NVM install script first, then verify and execute
    # (avoids curl-pipe-to-bash supply chain risk)
    - name: Download NVM install script to temp file
      get_url:
        url: "{{ nvm_install_url }}"
        dest: /tmp/nvm-install-{{ nvm_version }}.sh
        checksum: "sha256:{{ nvm_install_sha256 }}"
        mode: '0755'
        force: no
      when: nvm_check.results | selectattr('stat.exists', 'equalto', false) | list | length > 0

    - name: Verify NVM install script was downloaded successfully
      stat:
        path: /tmp/nvm-install-{{ nvm_version }}.sh
        checksum_algorithm: sha256
      register: nvm_script_stat
      when: nvm_check.results | selectattr('stat.exists', 'equalto', false) | list | length > 0

    - name: Fail if NVM install script is missing or empty
      fail:
        msg: "NVM install script download failed or file is empty"
      when:
        - nvm_check.results | selectattr('stat.exists', 'equalto', false) | list | length > 0
        - not (nvm_script_stat.stat.exists | default(false)) or (nvm_script_stat.stat.size | default(0)) == 0

    - name: Install NVM for users that do not have it
      command: bash /tmp/nvm-install-{{ nvm_version }}.sh
      args:
        creates: "{{ item.item.split(':')[1] }}/.nvm/nvm.sh"
      become_user: "{{ item.item.split(':')[0] }}"
      environment:
        HOME: "{{ item.item.split(':')[1] }}"
        NVM_DIR: "{{ item.item.split(':')[1] }}/.nvm"
      loop: "{{ nvm_check.results }}"
      loop_control:
        label: "{{ item.item.split(':')[0] }}"
      when: not item.stat.exists

    - name: Clean up NVM install script
      file:
        path: /tmp/nvm-install-{{ nvm_version }}.sh
        state: absent

    # ── Install Node.js v22 per user ────────────────────────────────────
    - name: Check if Node.js {{ node_version }} is installed for each user
      shell: |
        export NVM_DIR="{{ item.split(':')[1] }}/.nvm"
        . "$NVM_DIR/nvm.sh"
        nvm ls {{ node_version }} 2>/dev/null | grep -q "{{ node_version }}"
      become_user: "{{ item.split(':')[0] }}"
      environment:
        HOME: "{{ item.split(':')[1] }}"
      register: node_check
      loop: "{{ user_list }}"
      loop_control:
        label: "{{ item.split(':')[0] }}"
      changed_when: false
      failed_when: false

    - name: Install Node.js {{ node_version }} and set as default
      shell: |
        export NVM_DIR="{{ item.item.split(':')[1] }}/.nvm"
        . "$NVM_DIR/nvm.sh"
        nvm install {{ node_version }}
        nvm alias default {{ node_version }}
        nvm use default
      become_user: "{{ item.item.split(':')[0] }}"
      environment:
        HOME: "{{ item.item.split(':')[1] }}"
      loop: "{{ node_check.results }}"
      loop_control:
        label: "{{ item.item.split(':')[0] }}"
      when: item.rc != 0

    # ── Install Claude Code globally (per-user npm) ─────────────────────
    - name: Check if Claude Code is already installed for each user
      shell: |
        export NVM_DIR="{{ item.split(':')[1] }}/.nvm"
        . "$NVM_DIR/nvm.sh"
        npm list -g @anthropic-ai/claude-code 2>/dev/null | grep -q claude-code
      become_user: "{{ item.split(':')[0] }}"
      environment:
        HOME: "{{ item.split(':')[1] }}"
      register: claude_check
      loop: "{{ user_list }}"
      loop_control:
        label: "{{ item.split(':')[0] }}"
      changed_when: false
      failed_when: false

    - name: Install Claude Code via npm for users that do not have it
      shell: |
        export NVM_DIR="{{ item.item.split(':')[1] }}/.nvm"
        . "$NVM_DIR/nvm.sh"
        npm install -g @anthropic-ai/claude-code
      become_user: "{{ item.item.split(':')[0] }}"
      environment:
        HOME: "{{ item.item.split(':')[1] }}"
      loop: "{{ claude_check.results }}"
      loop_control:
        label: "{{ item.item.split(':')[0] }}"
      when: item.rc != 0

    # ── Ensure NVM is sourced in bashrc for all users ───────────────────
    - name: Ensure NVM is sourced in each user's bashrc
      blockinfile:
        path: "{{ item.split(':')[1] }}/.bashrc"
        marker: "# {mark} NVM (managed by InfraForge)"
        block: |
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
          [ -s "$NVM_DIR/bash_completion" ] && . "$NVM_DIR/bash_completion"
        insertafter: EOF
        create: true
        owner: "{{ item.split(':')[0] }}"
        mode: "0644"
      loop: "{{ user_list }}"
      loop_control:
        label: "{{ item.split(':')[0] }}"

    - name: Ensure NVM is sourced in /etc/skel/.bashrc for future users
      blockinfile:
        path: /etc/skel/.bashrc
        marker: "# {mark} NVM (managed by InfraForge)"
        block: |
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
          [ -s "$NVM_DIR/bash_completion" ] && . "$NVM_DIR/bash_completion"
        insertafter: EOF
        create: true
        mode: "0644"

    # ── Verification ────────────────────────────────────────────────────
    - name: Verify installation for each user
      shell: |
        export NVM_DIR="{{ item.split(':')[1] }}/.nvm"
        . "$NVM_DIR/nvm.sh"
        echo "node=$(node --version), claude-code=$(claude --version 2>/dev/null || echo 'not found')"
      become_user: "{{ item.split(':')[0] }}"
      environment:
        HOME: "{{ item.split(':')[1] }}"
      register: verify
      loop: "{{ user_list }}"
      loop_control:
        label: "{{ item.split(':')[0] }}"
      changed_when: false

    - name: Show installation status
      debug:
        msg: "{{ item.item.split(':')[0] }}: {{ item.stdout }}"
      loop: "{{ verify.results }}"
      loop_control:
        label: "{{ item.item.split(':')[0] }}"
