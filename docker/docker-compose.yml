# InfraForge phpIPAM Stack
# Managed by: infraforge setup

services:
  phpipam-db:
    image: mariadb:10.11
    container_name: infraforge-ipam-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: "${IPAM_DB_ROOT_PASS:-infraforge_root_pw}"
      MYSQL_DATABASE: phpipam
      MYSQL_USER: phpipam
      MYSQL_PASSWORD: "${IPAM_DB_PASS:-infraforge_ipam_pw}"
      IPAM_ADMIN_HASH: "${IPAM_ADMIN_HASH:-}"
    volumes:
      - phpipam-db-data:/var/lib/mysql
      - ./phpipam/initdb:/docker-entrypoint-initdb.d:ro
    networks:
      - infraforge-ipam
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  phpipam-web:
    image: phpipam/phpipam-www:latest
    container_name: infraforge-ipam-web
    restart: unless-stopped
    depends_on:
      phpipam-db:
        condition: service_healthy
    environment:
      TZ: "UTC"
      IPAM_DATABASE_HOST: phpipam-db
      IPAM_DATABASE_USER: phpipam
      IPAM_DATABASE_PASS: "${IPAM_DB_PASS:-infraforge_ipam_pw}"
      IPAM_DATABASE_NAME: phpipam
      IPAM_DISABLE_INSTALLER: 1
    ports:
      - "${IPAM_PORT:-8443}:443"
    volumes:
      - phpipam-logo:/phpipam/css/images/logo
      - ./phpipam/ssl:/etc/apache2/ssl:ro
      - ./phpipam/apache-ssl-phpipam.conf:/etc/apache2/conf.d/ssl.conf:ro
      - ./phpipam/config-override.php:/phpipam/config.docker.php:ro
    networks:
      - infraforge-ipam

  phpipam-cron:
    image: phpipam/phpipam-cron:latest
    container_name: infraforge-ipam-cron
    restart: unless-stopped
    depends_on:
      phpipam-db:
        condition: service_healthy
    environment:
      TZ: "UTC"
      IPAM_DATABASE_HOST: phpipam-db
      IPAM_DATABASE_USER: phpipam
      IPAM_DATABASE_PASS: "${IPAM_DB_PASS:-infraforge_ipam_pw}"
      IPAM_DATABASE_NAME: phpipam
      SCAN_INTERVAL: "${SCAN_INTERVAL:-15m}"
    networks:
      - infraforge-ipam

volumes:
  phpipam-db-data:
  phpipam-logo:

networks:
  infraforge-ipam:
    driver: bridge
